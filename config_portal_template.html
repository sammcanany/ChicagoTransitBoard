<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Transit Board</title>
    
    <!-- PWA / iOS Web App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Transit Board">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    
    <!-- iOS Icons (using emoji as data URI for simplicity) -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%23667eea' width='100' height='100' rx='20'/><text y='70' x='50' text-anchor='middle' font-size='60'>ðŸš‚</text></svg>">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            color: #1a1a1a;
            overflow-x: hidden;
        }

        .page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: #f5f5f5;
            transition: transform 0.3s ease-in-out;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            padding-bottom: calc(80px + env(safe-area-inset-bottom, 20px));
        }

        .page.hidden {
            display: none;
        }

        .page.slide-left {
            transform: translateX(-30%);
            filter: brightness(0.8);
            pointer-events: none;
        }

        /* Ensure page content has proper padding at bottom for scrolling */
        .page > :last-child {
            padding-bottom: 20px;
        }
        
        /* Ensure form sections have bottom spacing */
        .form-section:last-child {
            margin-bottom: 20px;
        }

        .header {
            background: #667eea;
            color: white;
            padding: 16px 20px;
            padding-top: calc(16px + env(safe-area-inset-top, 0px));
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .back-btn {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            margin: -8px;
            display: none;
        }

        .page:not(#main-page) .back-btn {
            display: block;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
        }

        .status-card {
            background: white;
            margin: 16px;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .status-item {
            text-align: center;
        }

        .status-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }

        .status-value {
            font-size: 16px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .status-value.online {
            color: #10b981;
        }

        .menu-list {
            background: white;
            margin: 16px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .menu-item {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }

        .menu-item:last-child {
            border-bottom: none;
        }

        .menu-item:active {
            background: #f5f5f5;
        }

        .menu-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 16px;
            flex-shrink: 0;
        }

        .menu-content {
            flex: 1;
            min-width: 0;
        }

        .menu-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .menu-subtitle {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .menu-arrow {
            color: #ccc;
            font-size: 20px;
        }

        .form-section {
            background: white;
            margin: 0 16px 16px;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #1a1a1a;
        }

        input[type="text"],
        input[type="password"],
        input[type="number"],
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            background: #ddd;
            border-radius: 3px;
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #667eea;
            border-radius: 50%;
            cursor: pointer;
            border: none;
        }

        .help-text {
            font-size: 13px;
            color: #666;
            margin-top: 6px;
        }

        .toggle-group {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 0;
        }

        .toggle-label {
            flex: 1;
            margin: 0;
        }

        .toggle-switch {
            position: relative;
            width: 52px;
            height: 32px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.3s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #667eea;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        .action-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 16px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom, 20px));
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            display: flex;
            gap: 12px;
            z-index: 100;
        }

        .btn {
            flex: 1;
            padding: 14px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        @media (max-width: 600px) {
            .status-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
</head>
<body>
    <!-- Main Menu Page -->
    <div id="main-page" class="page">
        <div class="header">
            <button class="back-btn" onclick="goBack()">
                <i data-lucide="chevron-left" style="width: 24px; height: 24px;"></i>
            </button>
            <div class="header-title">Settings</div>
        </div>

        <div class="status-card">
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-label">Status</div>
                    <div class="status-value {{STATUS_ONLINE_CLASS}}">{{WIFI_STATUS}}</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Version</div>
                    <div class="status-value">{{VERSION}}</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Uptime</div>
                    <div class="status-value">{{UPTIME}}</div>
                </div>
                <div class="status-item">
                    <div class="status-label">Memory</div>
                    <div class="status-value">{{MEMORY_PCT}}%</div>
                </div>
            </div>
        </div>

        <div class="menu-list">
            <div class="menu-item" onclick="navigateTo('wifi-page')">
                <div class="menu-icon" style="background: #e3f2fd; color: #1976d2;">
                    <i data-lucide="wifi" style="width: 24px; height: 24px;"></i>
                </div>
                <div class="menu-content">
                    <div class="menu-title">WiFi</div>
                    <div class="menu-subtitle">{{WIFI_SSID}}</div>
                </div>
                <div class="menu-arrow">â€º</div>
            </div>

            <div class="menu-item" onclick="navigateTo('api-page')">
                <div class="menu-icon" style="background: #fff3e0; color: #f57c00;">
                    <i data-lucide="key" style="width: 24px; height: 24px;"></i>
                </div>
                <div class="menu-content">
                    <div class="menu-title">API Keys</div>
                    <div class="menu-subtitle">Metra & CTA tokens</div>
                </div>
                <div class="menu-arrow">â€º</div>
            </div>

            <div class="menu-item" onclick="navigateTo('transit-page')">
                <div class="menu-icon" style="background: #e8f5e9; color: #388e3c;">
                    <i data-lucide="train-front" style="width: 24px; height: 24px;"></i>
                </div>
                <div class="menu-content">
                    <div class="menu-title">Transit Lines</div>
                    <div class="menu-subtitle">{{LINE_NAME}}</div>
                </div>
                <div class="menu-arrow">â€º</div>
            </div>

            <div class="menu-item" onclick="navigateTo('display-page')">
                <div class="menu-icon" style="background: #f3e5f5; color: #7b1fa2;">
                    <i data-lucide="monitor" style="width: 24px; height: 24px;"></i>
                </div>
                <div class="menu-content">
                    <div class="menu-title">Display</div>
                    <div class="menu-subtitle">Brightness, timing & layout</div>
                </div>
                <div class="menu-arrow">â€º</div>
            </div>

            <div class="menu-item" onclick="navigateTo('features-page')">
                <div class="menu-icon" style="background: #fce4ec; color: #c2185b;">
                    <i data-lucide="settings" style="width: 24px; height: 24px;"></i>
                </div>
                <div class="menu-content">
                    <div class="menu-title">Features</div>
                    <div class="menu-subtitle">Alerts, updates & more</div>
                </div>
                <div class="menu-arrow">â€º</div>
            </div>

            <div class="menu-item" onclick="navigateTo('weather-page')">
                <div class="menu-icon" style="background: #e0f7fa; color: #0097a7;">
                    <i data-lucide="cloud-sun" style="width: 24px; height: 24px;"></i>
                </div>
                <div class="menu-content">
                    <div class="menu-title">Weather</div>
                    <div class="menu-subtitle">{{WEATHER_STATUS}}</div>
                </div>
                <div class="menu-arrow">â€º</div>
            </div>

            <div class="menu-item" onclick="navigateTo('system-page')">
                <div class="menu-icon" style="background: #fff9c4; color: #f57f17;">
                    <i data-lucide="cpu" style="width: 24px; height: 24px;"></i>
                </div>
                <div class="menu-content">
                    <div class="menu-title">System</div>
                    <div class="menu-subtitle">Watchdog, sleep & power</div>
                </div>
                <div class="menu-arrow">â€º</div>
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-secondary" onclick="location.reload()">Refresh</button>
            <button class="btn btn-primary" onclick="saveConfiguration()">Save All</button>
        </div>
    </div>

    <!-- WiFi Settings Page -->
    <div id="wifi-page" class="page hidden">
        <div class="header">
            <button class="back-btn" onclick="goBack()">
                <i data-lucide="chevron-left" style="width: 24px; height: 24px;"></i>
            </button>
            <div class="header-title">WiFi Settings</div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label>Network Name (SSID)</label>
                <input type="text" id="wifi_ssid" name="wifi_ssid" value="{{WIFI_SSID}}" placeholder="Enter WiFi network name">
                <div class="help-text">Your WiFi network name</div>
            </div>

            <div class="form-group">
                <label>Password</label>
                <input type="password" id="wifi_password" name="wifi_password" value="" placeholder="Enter WiFi password">
                <div class="help-text">WiFi network password (leave blank to keep current)</div>
            </div>
        </div>
    </div>

    <!-- API Keys Page -->
    <div id="api-page" class="page hidden">
        <div class="header">
            <button class="back-btn" onclick="goBack()">
                <i data-lucide="chevron-left" style="width: 24px; height: 24px;"></i>
            </button>
            <div class="header-title">API Keys</div>
        </div>

        <div class="form-section">
            <div class="section-title">Metra</div>
            <div class="form-group">
                <label>API Token</label>
                <input type="text" id="metra_token" name="metra_token" value="{{METRA_TOKEN}}" placeholder="Enter Metra API token">
                <div class="help-text">Get from <a href="https://metra.com/developers" target="_blank">metra.com/developers</a></div>
            </div>
        </div>

        <div class="form-section">
            <div class="section-title">CTA</div>
            <div class="form-group">
                <label>API Key</label>
                <input type="text" id="cta_token" name="cta_token" value="{{CTA_TOKEN}}" placeholder="Enter CTA API key">
                <div class="help-text">Get from <a href="https://www.transitchicago.com/developers/" target="_blank">transitchicago.com/developers</a></div>
            </div>
        </div>
    </div>

    <!-- Transit Lines Page -->
    <div id="transit-page" class="page hidden">
        <div class="header">
            <button class="back-btn" onclick="goBack()">
                <i data-lucide="chevron-left" style="width: 24px; height: 24px;"></i>
            </button>
            <div class="header-title">Transit Lines</div>
        </div>

        <div class="form-section">
            <div class="section-title">Display Mode</div>
            
            <div class="form-group">
                <label>Rotation Mode</label>
                <select id="rotation_mode" name="rotation_mode" onchange="toggleRotationMode()">
                    <option value="direction" {{ROTATION_MODE_DIRECTION}}>Direction Rotation (1-2 lines)</option>
                    <option value="station" {{ROTATION_MODE_STATION}}>Station Rotation (3+ stations)</option>
                </select>
                <div class="help-text">Direction: show inbound/outbound for configured lines. Station: cycle through multiple stations</div>
            </div>
        </div>

        <!-- Direction Rotation Mode (Original) -->
        <div id="direction-mode-fields" style="{{DIRECTION_MODE_DISPLAY}}">
            <div class="form-section">
                <div class="section-title">Primary Line</div>

            <div class="form-group">
                <label>Transit Type</label>
                <select id="primary_transit_type" onchange="updateLineOptions('primary')">
                    <option value="metra">Metra</option>
                    <option value="cta">CTA</option>
                </select>
                <div class="help-text">Select Metra or CTA</div>
            </div>

            <div class="form-group">
                <label>Select Line</label>
                <select id="line_select" onchange="updateLine()">
                    <option value="">-- Select a Line --</option>
                    <optgroup label="Metra Lines" id="metra_lines_primary">
                        <option value="UP-N|Union Pacific North">Union Pacific North (UP-N)</option>
                        <option value="UP-NW|Union Pacific Northwest">Union Pacific Northwest (UP-NW)</option>
                        <option value="UP-W|Union Pacific West">Union Pacific West (UP-W)</option>
                        <option value="MD-N|Milwaukee District North">Milwaukee District North (MD-N)</option>
                        <option value="MD-W|Milwaukee District West">Milwaukee District West (MD-W)</option>
                        <option value="NCS|North Central Service">North Central Service (NCS)</option>
                        <option value="BNSF|BNSF Railway">BNSF Railway</option>
                        <option value="HC|Heritage Corridor">Heritage Corridor (HC)</option>
                        <option value="ME|Metra Electric">Metra Electric (ME)</option>
                        <option value="RI|Rock Island">Rock Island (RI)</option>
                        <option value="SWS|SouthWest Service">SouthWest Service (SWS)</option>
                    </optgroup>
                    <optgroup label="CTA Lines" id="cta_lines_primary" style="display:none;">
                        <option value="Red|Red Line">Red Line</option>
                        <option value="Blue|Blue Line">Blue Line</option>
                        <option value="Brown|Brown Line">Brown Line</option>
                        <option value="Green|Green Line">Green Line</option>
                        <option value="Orange|Orange Line">Orange Line</option>
                        <option value="Pink|Pink Line">Pink Line</option>
                        <option value="Purple|Purple Line">Purple Line</option>
                        <option value="Yellow|Yellow Line">Yellow Line</option>
                    </optgroup>
                </select>
                <div class="help-text">Choose your transit line</div>
            </div>

            <div class="form-group">
                <label>Station</label>
                <select id="primary_station_select" onchange="updatePrimaryStation()">
                    <option value="">-- Select a Station --</option>
                    <optgroup label="Metra Stations" id="metra_stations_primary">
                        <option value="RAVENSWOOD|Ravenswood">Ravenswood (UP-N)</option>
                        <option value="CLYBOURN|Clybourn">Clybourn (UP-N, UP-NW, UP-W)</option>
                        <option value="OTC|Ogilvie Transportation Center">Ogilvie Transportation Center (UP-N, UP-NW, UP-W)</option>
                        <option value="CUS|Chicago Union Station">Chicago Union Station (BNSF, HC, MD-N, MD-W, NCS, SWS)</option>
                        <option value="MILLENNIUM|Millennium Station">Millennium Station (ME)</option>
                        <option value="LAKEFOREST|Lake Forest">Lake Forest (UP-N)</option>
                        <option value="EVANSTON|Evanston (Davis St)">Evanston Davis St (UP-N)</option>
                        <option value="WILMETTE|Wilmette">Wilmette (UP-N)</option>
                        <option value="GLENCOE|Glencoe">Glencoe (UP-N)</option>
                        <option value="WINNETKA|Winnetka">Winnetka (UP-N)</option>
                        <option value="ARLINGTON|Arlington Heights">Arlington Heights (UP-NW)</option>
                        <option value="PALATINE|Palatine">Palatine (UP-NW)</option>
                        <option value="BARRINGTON|Barrington">Barrington (UP-NW)</option>
                        <option value="CRYSTAL|Crystal Lake">Crystal Lake (UP-NW)</option>
                        <option value="ELMHURST|Elmhurst">Elmhurst (UP-W)</option>
                        <option value="DOWNERS|Downers Grove">Downers Grove (BNSF)</option>
                        <option value="NAPERVILLE|Naperville">Naperville (BNSF)</option>
                        <option value="AURORA|Aurora">Aurora (BNSF)</option>
                        <option value="JOLIET|Joliet">Joliet (HC, RI)</option>
                        <option value="GLENVIEW|Glenview">Glenview (MD-N)</option>
                        <option value="LIBERTYVILLE|Libertyville">Libertyville (MD-N)</option>
                    </optgroup>
                    <optgroup label="CTA Stations" id="cta_stations_primary" style="display:none;">
                        <option value="40900|Howard">Howard (Red, Purple, Yellow)</option>
                        <option value="41450|95th/Dan Ryan">95th/Dan Ryan (Red)</option>
                        <option value="40730|O'Hare">O'Hare (Blue)</option>
                        <option value="40890|Forest Park">Forest Park (Blue)</option>
                        <option value="30249|Kimball">Kimball (Brown)</option>
                        <option value="41290|Harlem/Lake">Harlem/Lake (Green)</option>
                        <option value="40130|63rd/Ashland">63rd/Ashland (Green)</option>
                        <option value="40960|Midway">Midway (Orange)</option>
                        <option value="40580|54th/Cermak">54th/Cermak (Pink)</option>
                        <option value="40090|Linden">Linden (Purple)</option>
                        <option value="40140|Dempster-Skokie">Dempster-Skokie (Yellow)</option>
                    </optgroup>
                </select>
                <div class="help-text">Choose your station</div>
            </div>

            <!-- Hidden fields to store values -->
            <input type="hidden" id="line_id" name="line_id" value="{{LINE_ID}}">
            <input type="hidden" id="line_name" name="line_name" value="{{LINE_NAME}}">
            <input type="hidden" id="primary_station_id" name="primary_station_id" value="{{STATION_ID}}">
            <input type="hidden" id="primary_station_name" name="primary_station_name" value="{{STATION_NAME}}">
        </div>

        <div class="form-section">
            <div class="toggle-group">
                <label class="toggle-label">Enable Secondary Line</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="enable-secondary" name="enable-secondary" {{SECONDARY_CHECKED}} onchange="toggleSecondaryFields()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="help-text">Show a second transit line</div>

            <div id="secondary-fields" style="{{SECONDARY_DISPLAY}}; margin-top: 16px;">
                <div class="form-group">
                    <label>Transit Type</label>
                    <select id="secondary_transit_type" onchange="updateLineOptions('secondary')">
                        <option value="metra">Metra</option>
                        <option value="cta">CTA</option>
                    </select>
                    <div class="help-text">Select Metra or CTA</div>
                </div>

                <div class="form-group">
                    <label>Select Line</label>
                    <select id="secondary_line_select" onchange="updateSecondaryLine()">
                        <option value="">-- Select a Line --</option>
                        <optgroup label="Metra Lines" id="metra_lines_secondary">
                            <option value="UP-N|Union Pacific North">Union Pacific North (UP-N)</option>
                            <option value="UP-NW|Union Pacific Northwest">Union Pacific Northwest (UP-NW)</option>
                            <option value="UP-W|Union Pacific West">Union Pacific West (UP-W)</option>
                            <option value="MD-N|Milwaukee District North">Milwaukee District North (MD-N)</option>
                            <option value="MD-W|Milwaukee District West">Milwaukee District West (MD-W)</option>
                            <option value="NCS|North Central Service">North Central Service (NCS)</option>
                            <option value="BNSF|BNSF Railway">BNSF Railway</option>
                            <option value="HC|Heritage Corridor">Heritage Corridor (HC)</option>
                            <option value="ME|Metra Electric">Metra Electric (ME)</option>
                            <option value="RI|Rock Island">Rock Island (RI)</option>
                            <option value="SWS|SouthWest Service">SouthWest Service (SWS)</option>
                        </optgroup>
                        <optgroup label="CTA Lines" id="cta_lines_secondary" style="display:none;">
                            <option value="Red|Red Line">Red Line</option>
                            <option value="Blue|Blue Line">Blue Line</option>
                            <option value="Brown|Brown Line">Brown Line</option>
                            <option value="Green|Green Line">Green Line</option>
                            <option value="Orange|Orange Line">Orange Line</option>
                            <option value="Pink|Pink Line">Pink Line</option>
                            <option value="Purple|Purple Line">Purple Line</option>
                            <option value="Yellow|Yellow Line">Yellow Line</option>
                        </optgroup>
                    </select>
                    <div class="help-text">Choose secondary transit line</div>
                </div>

                <div class="form-group">
                    <label>Station</label>
                    <select id="secondary_station_select" onchange="updateSecondaryStation()">
                        <option value="">-- Select a Station --</option>
                        <optgroup label="Metra Stations" id="metra_stations_secondary">
                            <option value="RAVENSWOOD|Ravenswood">Ravenswood (UP-N)</option>
                            <option value="CLYBOURN|Clybourn">Clybourn (UP-N, UP-NW, UP-W)</option>
                            <option value="OTC|Ogilvie Transportation Center">Ogilvie Transportation Center (UP-N, UP-NW, UP-W)</option>
                            <option value="CUS|Chicago Union Station">Chicago Union Station (BNSF, HC, MD-N, MD-W, NCS, SWS)</option>
                            <option value="MILLENNIUM|Millennium Station">Millennium Station (ME)</option>
                            <option value="LAKEFOREST|Lake Forest">Lake Forest (UP-N)</option>
                            <option value="EVANSTON|Evanston (Davis St)">Evanston Davis St (UP-N)</option>
                            <option value="WILMETTE|Wilmette">Wilmette (UP-N)</option>
                            <option value="GLENCOE|Glencoe">Glencoe (UP-N)</option>
                            <option value="WINNETKA|Winnetka">Winnetka (UP-N)</option>
                            <option value="ARLINGTON|Arlington Heights">Arlington Heights (UP-NW)</option>
                            <option value="PALATINE|Palatine">Palatine (UP-NW)</option>
                            <option value="BARRINGTON|Barrington">Barrington (UP-NW)</option>
                            <option value="CRYSTAL|Crystal Lake">Crystal Lake (UP-NW)</option>
                            <option value="ELMHURST|Elmhurst">Elmhurst (UP-W)</option>
                            <option value="DOWNERS|Downers Grove">Downers Grove (BNSF)</option>
                            <option value="NAPERVILLE|Naperville">Naperville (BNSF)</option>
                            <option value="AURORA|Aurora">Aurora (BNSF)</option>
                            <option value="JOLIET|Joliet">Joliet (HC, RI)</option>
                            <option value="GLENVIEW|Glenview">Glenview (MD-N)</option>
                            <option value="LIBERTYVILLE|Libertyville">Libertyville (MD-N)</option>
                        </optgroup>
                        <optgroup label="CTA Stations" id="cta_stations_secondary" style="display:none;">
                            <option value="40900|Howard">Howard (Red, Purple, Yellow)</option>
                            <option value="41450|95th/Dan Ryan">95th/Dan Ryan (Red)</option>
                            <option value="40730|O'Hare">O'Hare (Blue)</option>
                            <option value="40890|Forest Park">Forest Park (Blue)</option>
                            <option value="30249|Kimball">Kimball (Brown)</option>
                            <option value="41290|Harlem/Lake">Harlem/Lake (Green)</option>
                            <option value="40130|63rd/Ashland">63rd/Ashland (Green)</option>
                            <option value="40960|Midway">Midway (Orange)</option>
                            <option value="40580|54th/Cermak">54th/Cermak (Pink)</option>
                            <option value="40090|Linden">Linden (Purple)</option>
                            <option value="40140|Dempster-Skokie">Dempster-Skokie (Yellow)</option>
                        </optgroup>
                    </select>
                    <div class="help-text">Choose secondary station</div>
                </div>

                <!-- Hidden fields for secondary -->
                <input type="hidden" id="secondary_line_id" name="secondary_line_id" value="{{SECONDARY_LINE_ID}}">
                <input type="hidden" id="secondary_line_name" name="secondary_line_name" value="{{SECONDARY_LINE_NAME}}">
                <input type="hidden" id="secondary_station_id" name="secondary_station_id" value="">
                <input type="hidden" id="secondary_station_name" name="secondary_station_name" value="">
            </div>
        </div>
        </div>
        <!-- End Direction Rotation Mode -->

        <!-- Station Rotation Mode -->
        <div id="station-mode-fields" style="{{STATION_MODE_DISPLAY}}">
            <div class="form-section">
                <div class="section-title">Station 1</div>
                
                <div class="form-group">
                    <label>Transit Type</label>
                    <select id="station1_transit_type" onchange="updateLineOptions('station1')">
                        <option value="metra">Metra</option>
                        <option value="cta">CTA</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Select Line</label>
                    <select id="station1_line_select" onchange="updateStationLine(1)">
                        <option value="">-- Select a Line --</option>
                        <optgroup label="Metra Lines" id="metra_lines_station1">
                            <option value="UP-N|Union Pacific North">Union Pacific North (UP-N)</option>
                            <option value="UP-NW|Union Pacific Northwest">Union Pacific Northwest (UP-NW)</option>
                            <option value="UP-W|Union Pacific West">Union Pacific West (UP-W)</option>
                            <option value="MD-N|Milwaukee District North">Milwaukee District North (MD-N)</option>
                            <option value="MD-W|Milwaukee District West">Milwaukee District West (MD-W)</option>
                            <option value="NCS|North Central Service">North Central Service (NCS)</option>
                            <option value="BNSF|BNSF Railway">BNSF Railway</option>
                            <option value="HC|Heritage Corridor">Heritage Corridor (HC)</option>
                            <option value="ME|Metra Electric">Metra Electric (ME)</option>
                            <option value="RI|Rock Island">Rock Island (RI)</option>
                            <option value="SWS|SouthWest Service">SouthWest Service (SWS)</option>
                        </optgroup>
                        <optgroup label="CTA Lines" id="cta_lines_station1" style="display:none;">
                            <option value="Red|Red Line">Red Line</option>
                            <option value="Blue|Blue Line">Blue Line</option>
                            <option value="Brown|Brown Line">Brown Line</option>
                            <option value="Green|Green Line">Green Line</option>
                            <option value="Orange|Orange Line">Orange Line</option>
                            <option value="Pink|Pink Line">Pink Line</option>
                            <option value="Purple|Purple Line">Purple Line</option>
                            <option value="Yellow|Yellow Line">Yellow Line</option>
                        </optgroup>
                    </select>
                </div>

                <div class="form-group">
                    <label>Station</label>
                    <select id="station1_station_select" onchange="updateStationInfo(1)">
                        <option value="">-- Select a Station --</option>
                        <optgroup label="Metra Stations" id="metra_stations_station1">
                            <option value="RAVENSWOOD|Ravenswood">Ravenswood (UP-N)</option>
                            <option value="CLYBOURN|Clybourn">Clybourn (UP-N, UP-NW, UP-W)</option>
                            <option value="OTC|Ogilvie Transportation Center">Ogilvie Transportation Center (UP-N, UP-NW, UP-W)</option>
                            <option value="CUS|Chicago Union Station">Chicago Union Station (BNSF, HC, MD-N, MD-W, NCS, SWS)</option>
                            <option value="MILLENNIUM|Millennium Station">Millennium Station (ME)</option>
                        </optgroup>
                        <optgroup label="CTA Stations" id="cta_stations_station1" style="display:none;">
                            <option value="40900|Howard">Howard (Red, Purple, Yellow)</option>
                            <option value="30249|Kimball">Kimball (Brown)</option>
                            <option value="40960|Midway">Midway (Orange)</option>
                        </optgroup>
                    </select>
                </div>

                <input type="hidden" id="station1_line_id" name="station1_line_id">
                <input type="hidden" id="station1_station_id" name="station1_station_id">
            </div>

            <div class="form-section">
                <div class="section-title">Station 2</div>
                
                <div class="form-group">
                    <label>Transit Type</label>
                    <select id="station2_transit_type" onchange="updateLineOptions('station2')">
                        <option value="metra">Metra</option>
                        <option value="cta">CTA</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Select Line</label>
                    <select id="station2_line_select" onchange="updateStationLine(2)">
                        <option value="">-- Select a Line --</option>
                        <optgroup label="Metra Lines" id="metra_lines_station2">
                            <option value="UP-N|Union Pacific North">Union Pacific North (UP-N)</option>
                            <option value="UP-NW|Union Pacific Northwest">Union Pacific Northwest (UP-NW)</option>
                            <option value="UP-W|Union Pacific West">Union Pacific West (UP-W)</option>
                            <option value="MD-N|Milwaukee District North">Milwaukee District North (MD-N)</option>
                            <option value="MD-W|Milwaukee District West">Milwaukee District West (MD-W)</option>
                            <option value="NCS|North Central Service">North Central Service (NCS)</option>
                            <option value="BNSF|BNSF Railway">BNSF Railway</option>
                            <option value="HC|Heritage Corridor">Heritage Corridor (HC)</option>
                            <option value="ME|Metra Electric">Metra Electric (ME)</option>
                            <option value="RI|Rock Island">Rock Island (RI)</option>
                            <option value="SWS|SouthWest Service">SouthWest Service (SWS)</option>
                        </optgroup>
                        <optgroup label="CTA Lines" id="cta_lines_station2" style="display:none;">
                            <option value="Red|Red Line">Red Line</option>
                            <option value="Blue|Blue Line">Blue Line</option>
                            <option value="Brown|Brown Line">Brown Line</option>
                            <option value="Green|Green Line">Green Line</option>
                            <option value="Orange|Orange Line">Orange Line</option>
                            <option value="Pink|Pink Line">Pink Line</option>
                            <option value="Purple|Purple Line">Purple Line</option>
                            <option value="Yellow|Yellow Line">Yellow Line</option>
                        </optgroup>
                    </select>
                </div>

                <div class="form-group">
                    <label>Station</label>
                    <select id="station2_station_select" onchange="updateStationInfo(2)">
                        <option value="">-- Select a Station --</option>
                        <optgroup label="Metra Stations" id="metra_stations_station2">
                            <option value="RAVENSWOOD|Ravenswood">Ravenswood (UP-N)</option>
                            <option value="CLYBOURN|Clybourn">Clybourn (UP-N, UP-NW, UP-W)</option>
                            <option value="OTC|Ogilvie Transportation Center">Ogilvie Transportation Center (UP-N, UP-NW, UP-W)</option>
                            <option value="CUS|Chicago Union Station">Chicago Union Station (BNSF, HC, MD-N, MD-W, NCS, SWS)</option>
                            <option value="MILLENNIUM|Millennium Station">Millennium Station (ME)</option>
                        </optgroup>
                        <optgroup label="CTA Stations" id="cta_stations_station2" style="display:none;">
                            <option value="40900|Howard">Howard (Red, Purple, Yellow)</option>
                            <option value="30249|Kimball">Kimball (Brown)</option>
                            <option value="40960|Midway">Midway (Orange)</option>
                        </optgroup>
                    </select>
                </div>

                <input type="hidden" id="station2_line_id" name="station2_line_id">
                <input type="hidden" id="station2_station_id" name="station2_station_id">
            </div>

            <div class="form-section">
                <div class="section-title">Station 3</div>
                
                <div class="form-group">
                    <label>Transit Type</label>
                    <select id="station3_transit_type" onchange="updateLineOptions('station3')">
                        <option value="metra">Metra</option>
                        <option value="cta">CTA</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Select Line</label>
                    <select id="station3_line_select" onchange="updateStationLine(3)">
                        <option value="">-- Select a Line --</option>
                        <optgroup label="Metra Lines" id="metra_lines_station3">
                            <option value="UP-N|Union Pacific North">Union Pacific North (UP-N)</option>
                            <option value="UP-NW|Union Pacific Northwest">Union Pacific Northwest (UP-NW)</option>
                            <option value="UP-W|Union Pacific West">Union Pacific West (UP-W)</option>
                            <option value="MD-N|Milwaukee District North">Milwaukee District North (MD-N)</option>
                            <option value="MD-W|Milwaukee District West">Milwaukee District West (MD-W)</option>
                            <option value="NCS|North Central Service">North Central Service (NCS)</option>
                            <option value="BNSF|BNSF Railway">BNSF Railway</option>
                            <option value="HC|Heritage Corridor">Heritage Corridor (HC)</option>
                            <option value="ME|Metra Electric">Metra Electric (ME)</option>
                            <option value="RI|Rock Island">Rock Island (RI)</option>
                            <option value="SWS|SouthWest Service">SouthWest Service (SWS)</option>
                        </optgroup>
                        <optgroup label="CTA Lines" id="cta_lines_station3" style="display:none;">
                            <option value="Red|Red Line">Red Line</option>
                            <option value="Blue|Blue Line">Blue Line</option>
                            <option value="Brown|Brown Line">Brown Line</option>
                            <option value="Green|Green Line">Green Line</option>
                            <option value="Orange|Orange Line">Orange Line</option>
                            <option value="Pink|Pink Line">Pink Line</option>
                            <option value="Purple|Purple Line">Purple Line</option>
                            <option value="Yellow|Yellow Line">Yellow Line</option>
                        </optgroup>
                    </select>
                </div>

                <div class="form-group">
                    <label>Station</label>
                    <select id="station3_station_select" onchange="updateStationInfo(3)">
                        <option value="">-- Select a Station --</option>
                        <optgroup label="Metra Stations" id="metra_stations_station3">
                            <option value="RAVENSWOOD|Ravenswood">Ravenswood (UP-N)</option>
                            <option value="CLYBOURN|Clybourn">Clybourn (UP-N, UP-NW, UP-W)</option>
                            <option value="OTC|Ogilvie Transportation Center">Ogilvie Transportation Center (UP-N, UP-NW, UP-W)</option>
                            <option value="CUS|Chicago Union Station">Chicago Union Station (BNSF, HC, MD-N, MD-W, NCS, SWS)</option>
                            <option value="MILLENNIUM|Millennium Station">Millennium Station (ME)</option>
                        </optgroup>
                        <optgroup label="CTA Stations" id="cta_stations_station3" style="display:none;">
                            <option value="40900|Howard">Howard (Red, Purple, Yellow)</option>
                            <option value="30249|Kimball">Kimball (Brown)</option>
                            <option value="40960|Midway">Midway (Orange)</option>
                        </optgroup>
                    </select>
                </div>

                <input type="hidden" id="station3_line_id" name="station3_line_id">
                <input type="hidden" id="station3_station_id" name="station3_station_id">
            </div>

            <div class="help-text" style="text-align: center; padding: 20px; color: #666;">
                Configure 3 or more stations to rotate through. Each station will show full screen with inbound/outbound before moving to the next.
            </div>
        </div>
        <!-- End Station Rotation Mode -->
    </div>

    <!-- Display Settings Page -->
    <div id="display-page" class="page hidden">
        <div class="header">
            <button class="back-btn" onclick="goBack()">
                <i data-lucide="chevron-left" style="width: 24px; height: 24px;"></i>
            </button>
            <div class="header-title">Display Settings</div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label>Brightness</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <input type="range" id="brightness" name="brightness" min="0.1" max="1.0" step="0.1" value="{{BRIGHTNESS}}"
                           oninput="document.getElementById('brightness-value').textContent = Math.round(this.value * 100) + '%'"
                           style="flex: 1;">
                    <span id="brightness-value" style="min-width: 45px; font-weight: 600;">{{BRIGHTNESS_PCT}}%</span>
                </div>
                <div class="help-text">Display brightness</div>
            </div>

            <div class="form-group">
                <label>Rotation Time (seconds)</label>
                <input type="number" id="rotation_time" name="rotation_time" min="1" max="30" value="{{ROTATION_TIME}}" placeholder="5">
                <div class="help-text">Time to show each direction</div>
            </div>

            <div class="form-group">
                <label>Update Interval (seconds)</label>
                <input type="number" id="update_interval" name="update_interval" min="10" max="300" value="{{UPDATE_INTERVAL}}" placeholder="30">
                <div class="help-text">Time between API updates</div>
            </div>

            <div class="form-group">
                <label>Trains to Display</label>
                <input type="number" id="num_trains" name="num_trains" min="1" max="8" value="{{NUM_TRAINS}}" placeholder="4">
                <div class="help-text">Number of trains per direction</div>
            </div>
        </div>
    </div>

    <!-- Features Page -->
    <div id="features-page" class="page hidden">
        <div class="header">
            <button class="back-btn" onclick="goBack()">
                <i data-lucide="chevron-left" style="width: 24px; height: 24px;"></i>
            </button>
            <div class="header-title">Features</div>
        </div>

        <div class="form-section">
            <div class="toggle-group">
                <label class="toggle-label">Service Alerts</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="enable-service-alerts" name="enable-service-alerts" {{SERVICE_ALERTS_CHECKED}}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="help-text">Show service disruption alerts</div>
        </div>

        <div class="form-section">
            <div class="toggle-group">
                <label class="toggle-label">Alert Icons</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="enable-alert-icons" name="enable-alert-icons" {{ALERT_ICONS_CHECKED}}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="help-text">Show warning icons on affected trains</div>
        </div>

        <div class="form-section">
            <label for="alerts_update_interval">Alert Update Interval (seconds)</label>
            <input type="number" id="alerts_update_interval" name="alerts_update_interval" min="60" max="600" value="{{ALERTS_UPDATE_INTERVAL}}" placeholder="180">
            <div class="help-text">How often to check for service alerts (default: 180 = 3 minutes)</div>
        </div>

        <div class="form-section">
            <div class="toggle-group">
                <label class="toggle-label">Auto-Update</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="enable-auto-update" name="enable-auto-update" {{AUTO_UPDATE_CHECKED}}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="help-text">Automatically check for updates</div>

            <div class="form-group" style="margin-top: 16px;">
                <label>Update Check Interval</label>
                <select id="check_update_interval" name="check_update_interval">
                    <option value="86400" {{UPDATE_DAILY_SELECTED}}>Daily</option>
                    <option value="604800" {{UPDATE_WEEKLY_SELECTED}}>Weekly</option>
                    <option value="2592000" {{UPDATE_MONTHLY_SELECTED}}>Monthly</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Weather Settings Page -->
    <div id="weather-page" class="page hidden">
        <div class="header">
            <button class="back-btn" onclick="goBack()">
                <i data-lucide="chevron-left" style="width: 24px; height: 24px;"></i>
            </button>
            <div class="header-title">Weather Settings</div>
        </div>

        <div class="form-section">
            <div class="toggle-group">
                <label class="toggle-label">Enable Weather</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="enable-weather" name="enable-weather" {{WEATHER_CHECKED}}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="help-text">Show weather icon and temperature</div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label>Weather Service</label>
                <select id="weather_api_service" name="weather_api_service">
                    <option value="weathergov" {{WEATHER_GOV_SELECTED}}>Weather.gov (Free, US only)</option>
                    <option value="openweathermap" {{WEATHER_OWM_SELECTED}}>OpenWeatherMap (API key required)</option>
                </select>
            </div>
            <div class="help-text">Choose weather data provider</div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label>ZIP Code / Location</label>
                <input type="text" id="weather_zip_code" name="weather_zip_code" value="{{WEATHER_ZIP}}" placeholder="60601">
            </div>
            <div class="help-text">Your location for weather data</div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label>API Key (OpenWeatherMap only)</label>
                <input type="password" id="weather_api_key" name="weather_api_key" value="{{WEATHER_API_KEY}}" placeholder="Enter API key">
            </div>
            <div class="help-text">Required for OpenWeatherMap</div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label>Display Mode</label>
                <select id="weather_display_mode" name="weather_display_mode">
                    <option value="icon_only" {{WEATHER_ICON_SELECTED}}>Icon only</option>
                    <option value="icon_and_temp" {{WEATHER_TEMP_SELECTED}}>Icon + Temperature</option>
                </select>
            </div>
            <div class="help-text">How to show weather on display</div>
        </div>

        <div class="form-section">
            <div class="form-group">
                <label>Update Interval</label>
                <select id="weather_update_interval" name="weather_update_interval">
                    <option value="900" {{WEATHER_15MIN_SELECTED}}>15 minutes</option>
                    <option value="1800" {{WEATHER_30MIN_SELECTED}}>30 minutes</option>
                    <option value="3600" {{WEATHER_60MIN_SELECTED}}>1 hour</option>
                </select>
            </div>
            <div class="help-text">How often to fetch weather data</div>
        </div>
    </div>

    <!-- System Settings Page -->
    <div id="system-page" class="page hidden">
        <div class="header">
            <button class="back-btn" onclick="goBack()">
                <i data-lucide="chevron-left" style="width: 24px; height: 24px;"></i>
            </button>
            <div class="header-title">System Settings</div>
        </div>

        <div class="form-section">
            <div class="toggle-group">
                <label class="toggle-label">Watchdog Timer</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="enable-watchdog" name="enable-watchdog" {{WATCHDOG_CHECKED}}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="help-text">Auto-reboot if system hangs (recommended)</div>

            <div class="form-group" style="margin-top: 16px;">
                <label>Watchdog Timeout</label>
                <select id="watchdog_timeout" name="watchdog_timeout">
                    <option value="5000" {{WATCHDOG_5S_SELECTED}}>5 seconds</option>
                    <option value="8000" {{WATCHDOG_8S_SELECTED}}>8 seconds</option>
                    <option value="10000" {{WATCHDOG_10S_SELECTED}}>10 seconds</option>
                </select>
            </div>
        </div>

        <div class="form-section">
            <div class="toggle-group">
                <label class="toggle-label">Sleep Mode</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="enable-sleep" name="enable-sleep" {{SLEEP_CHECKED}}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="help-text">Dim display during night hours</div>

            <div class="form-group" style="margin-top: 16px;">
                <label>Sleep Start Hour</label>
                <select id="sleep-start-hour" name="sleep-start-hour">
                    <option value="20" {{SLEEP_START_20_SELECTED}}>8 PM</option>
                    <option value="21" {{SLEEP_START_21_SELECTED}}>9 PM</option>
                    <option value="22" {{SLEEP_START_22_SELECTED}}>10 PM</option>
                    <option value="23" {{SLEEP_START_23_SELECTED}}>11 PM</option>
                    <option value="0" {{SLEEP_START_0_SELECTED}}>Midnight</option>
                </select>
            </div>

            <div class="form-group" style="margin-top: 16px;">
                <label>Sleep End Hour</label>
                <select id="sleep-end-hour" name="sleep-end-hour">
                    <option value="5" {{SLEEP_END_5_SELECTED}}>5 AM</option>
                    <option value="6" {{SLEEP_END_6_SELECTED}}>6 AM</option>
                    <option value="7" {{SLEEP_END_7_SELECTED}}>7 AM</option>
                    <option value="8" {{SLEEP_END_8_SELECTED}}>8 AM</option>
                </select>
            </div>

            <div class="form-group" style="margin-top: 16px;">
                <label>Sleep Brightness</label>
                <div style="display: flex; align-items: center; gap: 12px;">
                    <input type="range" id="sleep-brightness" name="sleep-brightness" min="0.05" max="0.3" step="0.05" value="{{SLEEP_BRIGHTNESS}}"
                           oninput="document.getElementById('sleep-brightness-value').textContent = Math.round(this.value * 100) + '%'"
                           style="flex: 1;">
                    <span id="sleep-brightness-value" style="min-width: 45px; font-weight: 600;">{{SLEEP_BRIGHTNESS_PCT}}%</span>
                </div>
            </div>
        </div>

        <div class="form-section">
            <div class="toggle-group">
                <label class="toggle-label">Adaptive Brightness</label>
                <label class="toggle-switch">
                    <input type="checkbox" id="enable-adaptive" name="enable-adaptive" {{ADAPTIVE_CHECKED}}>
                    <span class="toggle-slider"></span>
                </label>
            </div>
            <div class="help-text">Auto-adjust brightness by time of day</div>
            <div class="help-text" style="margin-top: 8px; color: #999;">Day: 100% | Evening: 70% | Night: 30%</div>
            <div class="help-text" style="margin-top: 4px; color: #f57c00;">âš ï¸ Cannot use with Sleep Mode</div>
        </div>
    </div>

    <script>
        let currentPage = 'main-page';
        let pageStack = [];

        function navigateTo(pageId) {
            const currentPageEl = document.getElementById(currentPage);
            const newPageEl = document.getElementById(pageId);

            pageStack.push(currentPage);

            // Show new page immediately, then animate
            newPageEl.classList.remove('hidden');
            newPageEl.style.transform = 'translateX(100%)';

            // Trigger animation
            setTimeout(() => {
                currentPageEl.classList.add('slide-left');
                newPageEl.style.transform = 'translateX(0)';
            }, 10);

            // Hide old page after animation
            setTimeout(() => {
                if (currentPageEl.classList.contains('slide-left')) {
                    currentPageEl.classList.add('hidden');
                    currentPageEl.classList.remove('slide-left');
                }
                
                // Reinitialize Lucide icons after page transition
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 300);

            currentPage = pageId;
        }

        function goBack() {
            if (pageStack.length === 0) return;

            const currentPageEl = document.getElementById(currentPage);
            const previousPageId = pageStack.pop();
            const previousPageEl = document.getElementById(previousPageId);

            // Show previous page in slide-left position
            previousPageEl.classList.remove('hidden');
            previousPageEl.classList.add('slide-left');

            // Trigger animation
            setTimeout(() => {
                currentPageEl.style.transform = 'translateX(100%)';
                previousPageEl.classList.remove('slide-left');
            }, 10);

            // Hide current page after animation
            setTimeout(() => {
                currentPageEl.classList.add('hidden');
                currentPageEl.style.transform = 'translateX(0)';
            }, 300);

            currentPage = previousPageId;
        }

        function toggleSecondaryFields() {
            const checkbox = document.getElementById('enable-secondary');
            const fields = document.getElementById('secondary-fields');
            fields.style.display = checkbox.checked ? 'block' : 'none';
        }

        function toggleRotationMode() {
            const mode = document.getElementById('rotation_mode').value;
            const directionFields = document.getElementById('direction-mode-fields');
            const stationFields = document.getElementById('station-mode-fields');
            
            if (mode === 'direction') {
                directionFields.style.display = 'block';
                stationFields.style.display = 'none';
            } else {
                directionFields.style.display = 'none';
                stationFields.style.display = 'block';
            }
        }

        function updateLineOptions(which) {
            var transitType = document.getElementById(which + '_transit_type').value;
            var metraLineGroup = document.getElementById(which === 'primary' ? 'metra_lines_primary' : 'metra_lines_secondary');
            var ctaLineGroup = document.getElementById(which === 'primary' ? 'cta_lines_primary' : 'cta_lines_secondary');
            var metraStationGroup = document.getElementById(which === 'primary' ? 'metra_stations_primary' : 'metra_stations_secondary');
            var ctaStationGroup = document.getElementById(which === 'primary' ? 'cta_stations_primary' : 'cta_stations_secondary');

            if (transitType === 'metra') {
                metraLineGroup.style.display = '';
                ctaLineGroup.style.display = 'none';
                metraStationGroup.style.display = '';
                ctaStationGroup.style.display = 'none';
            } else {
                metraLineGroup.style.display = 'none';
                ctaLineGroup.style.display = '';
                metraStationGroup.style.display = 'none';
                ctaStationGroup.style.display = '';
            }

            // Reset selections
            var lineSelect = document.getElementById(which === 'primary' ? 'line_select' : 'secondary_line_select');
            var stationSelect = document.getElementById(which === 'primary' ? 'primary_station_select' : 'secondary_station_select');
            lineSelect.selectedIndex = 0;
            stationSelect.selectedIndex = 0;
        }

        function updateLine() {
            var select = document.getElementById('line_select');
            var lineId = document.getElementById('line_id');
            var lineName = document.getElementById('line_name');

            if (select.value) {
                var parts = select.value.split('|');
                lineId.value = parts[0];
                lineName.value = parts[1];
            } else {
                lineId.value = '';
                lineName.value = '';
            }
        }

        function updatePrimaryStation() {
            var select = document.getElementById('primary_station_select');
            var stationId = document.getElementById('primary_station_id');
            var stationName = document.getElementById('primary_station_name');

            if (select.value) {
                var parts = select.value.split('|');
                stationId.value = parts[0];
                stationName.value = parts[1];
            } else {
                stationId.value = '';
                stationName.value = '';
            }
        }

        function updateSecondaryLine() {
            var select = document.getElementById('secondary_line_select');
            var lineId = document.getElementById('secondary_line_id');
            var lineName = document.getElementById('secondary_line_name');

            if (select.value) {
                var parts = select.value.split('|');
                lineId.value = parts[0];
                lineName.value = parts[1];
            } else {
                lineId.value = '';
                lineName.value = '';
            }
        }

        function updateSecondaryStation() {
            var select = document.getElementById('secondary_station_select');
            var stationId = document.getElementById('secondary_station_id');
            var stationName = document.getElementById('secondary_station_name');

            if (select.value) {
                var parts = select.value.split('|');
                stationId.value = parts[0];
                stationName.value = parts[1];
            } else {
                stationId.value = '';
                stationName.value = '';
            }
        }

        function updateStationLine(stationNum) {
            var select = document.getElementById('station' + stationNum + '_line_select');
            var lineId = document.getElementById('station' + stationNum + '_line_id');

            if (select.value) {
                var parts = select.value.split('|');
                lineId.value = parts[0];
            } else {
                lineId.value = '';
            }
        }

        function updateStationInfo(stationNum) {
            var select = document.getElementById('station' + stationNum + '_station_select');
            var stationId = document.getElementById('station' + stationNum + '_station_id');

            if (select.value) {
                var parts = select.value.split('|');
                stationId.value = parts[0];
            } else {
                stationId.value = '';
            }
        }

        function saveConfiguration() {
            // Collect all form data
            const formData = new FormData();
            
            // Collect all input, select, and checkbox elements (including hidden inputs)
            const inputs = document.querySelectorAll('input[type="text"], input[type="password"], input[type="number"], input[type="range"], input[type="hidden"], select');
            inputs.forEach(input => {
                if (input.name || input.id) {
                    const key = input.name || input.id;
                    formData.append(key, input.value);
                }
            });
            
            // Collect checkbox values
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.id || checkbox.name) {
                    const key = checkbox.name || checkbox.id;
                    formData.append(key, checkbox.checked ? 'true' : 'false');
                }
            });
            
            // Send to server
            fetch('/save', {
                method: 'POST',
                body: new URLSearchParams(formData)
            })
            .then(response => response.text())
            .then(data => {
                alert('Configuration saved! Board is restarting...');
                console.log('Server response:', data);
            })
            .catch(error => {
                alert('Error saving configuration: ' + error);
                console.error('Save error:', error);
            });
        }

        // Initialize on page load - ensure we're on the main page
        window.addEventListener('DOMContentLoaded', function() {
            currentPage = 'main-page';
            pageStack = [];

            // Initialize rotation mode visibility
            toggleRotationMode();

            // Load current values into dropdowns
            loadCurrentValues();

            // Hide all pages except main
            const allPages = document.querySelectorAll('.page');
            allPages.forEach(page => {
                if (page.id !== 'main-page') {
                    page.classList.add('hidden');
                    page.classList.remove('slide-left');
                } else {
                    // Ensure main page is fully visible
                    page.classList.remove('hidden');
                    page.classList.remove('slide-left');
                    page.style.visibility = 'visible';
                    page.style.pointerEvents = 'auto';
                }
            });
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });

        // Load current config values into dropdowns
        function loadCurrentValues() {
            // Get stored values from hidden fields
            var lineId = document.getElementById('line_id').value;
            var lineName = document.getElementById('line_name').value;
            var stationId = document.getElementById('primary_station_id').value;
            var stationName = document.getElementById('primary_station_name').value;

            // Set primary line dropdown
            if (lineId && lineName) {
                var lineSelect = document.getElementById('line_select');
                var lineValue = lineId + '|' + lineName;
                for (var i = 0; i < lineSelect.options.length; i++) {
                    if (lineSelect.options[i].value === lineValue || lineSelect.options[i].value.startsWith(lineId + '|')) {
                        lineSelect.selectedIndex = i;
                        break;
                    }
                }
            }

            // Set primary station dropdown
            if (stationId && stationName) {
                var stationSelect = document.getElementById('primary_station_select');
                var stationValue = stationId + '|' + stationName;
                for (var i = 0; i < stationSelect.options.length; i++) {
                    if (stationSelect.options[i].value === stationValue || stationSelect.options[i].value.startsWith(stationId + '|')) {
                        stationSelect.selectedIndex = i;
                        break;
                    }
                }
            }

            // Secondary line
            var secondaryLineId = document.getElementById('secondary_line_id').value;
            var secondaryLineName = document.getElementById('secondary_line_name').value;
            if (secondaryLineId && secondaryLineName) {
                var secondaryLineSelect = document.getElementById('secondary_line_select');
                var secondaryLineValue = secondaryLineId + '|' + secondaryLineName;
                for (var i = 0; i < secondaryLineSelect.options.length; i++) {
                    if (secondaryLineSelect.options[i].value === secondaryLineValue || secondaryLineSelect.options[i].value.startsWith(secondaryLineId + '|')) {
                        secondaryLineSelect.selectedIndex = i;
                        break;
                    }
                }
            }
        }
    </script>
</body>
</html>
